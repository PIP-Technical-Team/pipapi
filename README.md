
<!-- README.md is generated from README.Rmd. Please edit that file -->

# pipapi

<!-- badges: start -->
<!-- [![Codecov test coverage](https://codecov.io/gh/PIP-Technical-Team/pipapi/branch/master/graph/badge.svg)](https://codecov.io/gh/PIP-Technical-Team/pipapi?branch=master) -->
<!-- badges: end -->

The goal of pipapi is to provide a high level API to the computations
and methods that power the Poverty and Inequality Platform (PIP).

World Bank staff who have read access to the PIP data can use the
functions from this package directly (without hitting the PIP API)

## Installation

You can install the development version from
[GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("PIP-Technical-Team/pipapi")
```

## Getting started

The main function from the `pipapi` package is the `pip()` function. See
`?pip` for more information.

### Data access

In order to use the `pip()` you’ll need to have access to PIP
`data_folder`. The folder structure looks like this:

``` bash
data-folder-root/
├─ _aux/
│  ├─ pop-regions.fst
│  ├─ pop.fst
├─ estimations/
│  ├─ survey_means.fst
│  ├─ interpolated_means.fst
│  ├─ dist_stats.fst
├─ survey_data/
│  ├─ survey_1.fst
│  ├─ ...
│  ├─ survey_n.fst
```

``` r
# Create a list of look-up tables from the root data folder
lkups <- pipapi:::clean_api_data(
  data_folder_root = "path/to/data_folder")
```

    #> List of 6
    #>  $ svy_lkup      :Classes 'data.table' and 'data.frame': 17 obs. of  27 variables:
    #>   ..$ survey_id              : chr [1:17] "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" "ARE_2014_HIES_V01_M_V01_A_PIP_PC-GROUP" "ARG_1986_EPH_V01_M_V01_A_PIP_PC-HIST" "BDI_1992_EDCM_V01_M_V01_A_PIP_PC-GROUP" ...
    #>   ..$ cache_id               : chr [1:17] "AGO_2000_HBS_D1_CON_GPWG" "ARE_2014_HIES_D1_INC_GROUP" "ARG_1986_EPH_D1_INC_HIST" "BDI_1992_EDCM_D1_CON_GROUP" ...
    #>   ..$ wb_region_code         : chr [1:17] "SSA" "MNA" "LAC" "SSA" ...
    #>   ..$ pcn_region_code        : chr [1:17] "SSA" "OHI" "LAC" "SSA" ...
    #>   ..$ country_code           : chr [1:17] "AGO" "ARE" "ARG" "BDI" ...
    #>   ..$ survey_acronym         : chr [1:17] "HBS" "HIES" "EPH" "EDCM" ...
    #>   ..$ survey_coverage        : chr [1:17] "national" "national" "urban" "national" ...
    #>   ..$ survey_comparability   : num [1:17] 0 0 0 0 0 0 1 1 1 0 ...
    #>   ..$ surveyid_year          : num [1:17] 2000 2014 1986 1992 1981 ...
    #>   ..$ reporting_year         : num [1:17] 2000 2013 1986 1992 1981 ...
    #>   ..$ survey_year            : num [1:17] 2000 2013 1986 1992 1981 ...
    #>   ..$ welfare_type           : chr [1:17] "consumption" "income" "income" "consumption" ...
    #>   ..$ survey_mean_lcu        : num [1:17] 11.2326 6.1787 5.3478 2.3917 0.0411 ...
    #>   ..$ survey_mean_ppp        : num [1:17] 4.1 2.5085 24.8472 0.0454 0.0765 ...
    #>   ..$ reporting_pop          : num [1:17] 1.64e+07 9.20e+06 3.07e+07 5.69e+06 7.94e+08 ...
    #>   ..$ ppp                    : num [1:17] 80.93 2.4 3.16 496.12 3.04 ...
    #>   ..$ cpi                    : num [1:17] 0.0339 1.0277 0.0681 0.1061 0.1769 ...
    #>   ..$ pop_data_level         : chr [1:17] "national" "national" "national" "national" ...
    #>   ..$ gdp_data_level         : chr [1:17] "national" "national" "national" "national" ...
    #>   ..$ pce_data_level         : chr [1:17] "national" "national" "national" "national" ...
    #>   ..$ cpi_data_level         : chr [1:17] "national" "national" "national" "national" ...
    #>   ..$ ppp_data_level         : chr [1:17] "national" "national" "national" "national" ...
    #>   ..$ distribution_type      : chr [1:17] "micro" "group" "micro" "group" ...
    #>   ..$ gd_type                : chr [1:17] "" "T05" "" "T05" ...
    #>   ..$ is_interpolated        : logi [1:17] FALSE FALSE FALSE FALSE FALSE FALSE ...
    #>   ..$ is_used_for_aggregation: logi [1:17] FALSE FALSE FALSE FALSE TRUE TRUE ...
    #>   ..$ path                   : chr [1:17] "./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst" "./tests/testdata/20210401/survey_data/ARE_2014_HIES_D1_INC_GROUP.fst" "./tests/testdata/20210401/survey_data/ARG_1986_EPH_D1_INC_HIST.fst" "./tests/testdata/20210401/survey_data/BDI_1992_EDCM_D1_CON_GROUP.fst" ...
    #>   ..- attr(*, ".internal.selfref")=<externalptr> 
    #>  $ ref_lkup      :Classes 'data.table' and 'data.frame': 164 obs. of  31 variables:
    #>   ..$ survey_id              : chr [1:164] "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" ...
    #>   ..$ cache_id               : chr [1:164] "AGO_2000_HBS_D1_CON_GPWG" "AGO_2000_HBS_D1_CON_GPWG" "AGO_2000_HBS_D1_CON_GPWG" "AGO_2000_HBS_D1_CON_GPWG" ...
    #>   ..$ wb_region_code         : chr [1:164] "SSA" "SSA" "SSA" "SSA" ...
    #>   ..$ pcn_region_code        : chr [1:164] "SSA" "SSA" "SSA" "SSA" ...
    #>   ..$ country_code           : chr [1:164] "AGO" "AGO" "AGO" "AGO" ...
    #>   ..$ reporting_year         : int [1:164] 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 ...
    #>   ..$ surveyid_year          : num [1:164] 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 ...
    #>   ..$ survey_year            : num [1:164] 2000 2000 2000 2000 2000 ...
    #>   ..$ survey_acronym         : chr [1:164] "HBS" "HBS" "HBS" "HBS" ...
    #>   ..$ survey_coverage        : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ survey_comparability   : num [1:164] 0 0 0 0 0 0 0 0 0 0 ...
    #>   ..$ welfare_type           : chr [1:164] "consumption" "consumption" "consumption" "consumption" ...
    #>   ..$ survey_mean_lcu        : num [1:164] 11.2 11.2 11.2 11.2 11.2 ...
    #>   ..$ survey_mean_ppp        : num [1:164] 4.1 4.1 4.1 4.1 4.1 ...
    #>   ..$ predicted_mean_ppp     : num [1:164] 5.47 5.28 5.31 5.43 5.42 ...
    #>   ..$ ppp                    : num [1:164] 80.9 80.9 80.9 80.9 80.9 ...
    #>   ..$ reporting_pop          : num [1:164] 8640446 8952950 9278096 9614754 9961997 ...
    #>   ..$ reporting_gdp          : num [1:164] 2947 2844 2860 2925 2922 ...
    #>   ..$ reporting_pce          : num [1:164] NA NA NA NA NA NA NA NA NA NA ...
    #>   ..$ pop_data_level         : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ gdp_data_level         : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ pce_data_level         : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ cpi_data_level         : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ ppp_data_level         : chr [1:164] "national" "national" "national" "national" ...
    #>   ..$ distribution_type      : chr [1:164] "micro" "micro" "micro" "micro" ...
    #>   ..$ gd_type                : chr [1:164] "" "" "" "" ...
    #>   ..$ is_interpolated        : logi [1:164] TRUE TRUE TRUE TRUE TRUE TRUE ...
    #>   ..$ is_used_for_aggregation: logi [1:164] FALSE FALSE FALSE FALSE FALSE FALSE ...
    #>   ..$ estimation_type        : chr [1:164] "extrapolation" "extrapolation" "extrapolation" "extrapolation" ...
    #>   ..$ path                   : chr [1:164] "./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst" "./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst" "./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst" "./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst" ...
    #>   ..$ interpolation_id       : chr [1:164] "AGO_1981_national" "AGO_1982_national" "AGO_1983_national" "AGO_1984_national" ...
    #>   ..- attr(*, ".internal.selfref")=<externalptr> 
    #>  $ dist_stats    :Classes 'data.table' and 'data.frame': 12 obs. of  28 variables:
    #>   ..$ survey_id        : chr [1:12] "AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG" "ARE_2014_HIES_V01_M_V01_A_PIP_PC-GROUP" "ARG_1986_EPH_V01_M_V01_A_PIP_PC-HIST" "BDI_1992_EDCM_V01_M_V01_A_PIP_PC-GROUP" ...
    #>   ..$ cache_id         : chr [1:12] "AGO_2000_HBS_D1_CON_GPWG" "ARE_2014_HIES_D1_INC_GROUP" "ARG_1986_EPH_D1_INC_HIST" "BDI_1992_EDCM_D1_CON_GROUP" ...
    #>   ..$ wb_region_code   : chr [1:12] "SSA" "MNA" "LAC" "SSA" ...
    #>   ..$ pcn_region_code  : chr [1:12] "SSA" "OHI" "LAC" "SSA" ...
    #>   ..$ country_code     : chr [1:12] "AGO" "ARE" "ARG" "BDI" ...
    #>   ..$ survey_acronym   : chr [1:12] "HBS" "HIES" "EPH" "EDCM" ...
    #>   ..$ surveyid_year    : num [1:12] 2000 2014 1986 1992 1989 ...
    #>   ..$ survey_year      : num [1:12] 2000 2013 1986 1992 1989 ...
    #>   ..$ reporting_year   : num [1:12] 2000 2013 1986 1992 1989 ...
    #>   ..$ welfare_type     : chr [1:12] "consumption" "income" "income" "consumption" ...
    #>   ..$ pop_data_level   : chr [1:12] "national" "national" "national" "national" ...
    #>   ..$ survey_median_lcu: num [1:12] 7.105 5.556 3.858 1.943 0.245 ...
    #>   ..$ survey_median_ppp: num [1:12] 2.5934 2.2555 17.9229 0.0369 0.163 ...
    #>   ..$ decile1          : num [1:12] 0.00983 0.0235 0.01768 0.03414 0.01663 ...
    #>   ..$ decile2          : num [1:12] 0.022 0.0386 0.0336 0.0453 0.0253 ...
    #>   ..$ decile3          : num [1:12] 0.0334 0.0531 0.0435 0.0555 0.0344 ...
    #>   ..$ decile4          : num [1:12] 0.045 0.0674 0.0552 0.0654 0.0445 ...
    #>   ..$ decile5          : num [1:12] 0.0566 0.0822 0.0667 0.0758 0.0559 ...
    #>   ..$ decile6          : num [1:12] 0.0705 0.0982 0.0798 0.0872 0.0695 ...
    #>   ..$ decile7          : num [1:12] 0.0881 0.1164 0.0974 0.101 0.087 ...
    #>   ..$ decile8          : num [1:12] 0.113 0.138 0.121 0.12 0.112 ...
    #>   ..$ decile9          : num [1:12] 0.159 0.168 0.163 0.15 0.157 ...
    #>   ..$ decile10         : num [1:12] 0.402 0.214 0.322 0.266 0.398 ...
    #>   ..$ mean             : num [1:12] 11.233 6.179 5.348 2.392 0.393 ...
    #>   ..$ gini             : num [1:12] 0.52 0.325 0.428 0.333 0.505 ...
    #>   ..$ polarization     : num [1:12] 0.464 0.323 0.385 0.282 0.457 ...
    #>   ..$ mld              : num [1:12] 0.513 0.195 0.311 0.182 0.447 ...
    #>   ..$ problem          : chr [1:12] "AGO_2000_HBS_D1_CON_GPWG-national" "ARE_2014_HIES_D1_INC_GROUP-national" "ARG_1986_EPH_D1_INC_HIST-national" "BDI_1992_EDCM_D1_CON_GROUP-national" ...
    #>   ..- attr(*, ".internal.selfref")=<externalptr> 
    #>  $ pop_region    :Classes 'data.table' and 'data.frame': 308 obs. of  4 variables:
    #>   ..$ region_code   : chr [1:308] "OHI" "OHI" "OHI" "OHI" ...
    #>   ..$ reporting_year: num [1:308] 1977 1978 1979 1980 1981 ...
    #>   ..$ reporting_pop : num [1:308] 1.64e+09 1.65e+09 1.67e+09 1.68e+09 1.69e+09 ...
    #>   ..$ grouping_type : chr [1:308] "WB" "WB" "WB" "WB" ...
    #>   ..- attr(*, ".internal.selfref")=<externalptr> 
    #>  $ query_controls:List of 11
    #>   ..$ country        :List of 2
    #>   .. ..$ values: chr [1:12] "all" "AGO" "ARE" "ARG" ...
    #>   .. ..$ type  : chr "character"
    #>   ..$ year           :List of 2
    #>   .. ..$ values: chr [1:40] "all" "1981" "1982" "1983" ...
    #>   .. ..$ type  : chr "character"
    #>   ..$ povline        :List of 2
    #>   .. ..$ values: Named num [1:2] 0 100
    #>   .. .. ..- attr(*, "names")= chr [1:2] "min" "max"
    #>   .. ..$ type  : chr "numeric"
    #>   ..$ popshare       :List of 2
    #>   .. ..$ values: Named num [1:2] 0 1
    #>   .. .. ..- attr(*, "names")= chr [1:2] "min" "max"
    #>   .. ..$ type  : chr "numeric"
    #>   ..$ fill_gaps      :List of 2
    #>   .. ..$ values: logi [1:2] TRUE FALSE
    #>   .. ..$ type  : chr "logical"
    #>   ..$ aggregate      :List of 2
    #>   .. ..$ values: logi [1:2] TRUE FALSE
    #>   .. ..$ type  : chr "logical"
    #>   ..$ group_by       :List of 2
    #>   .. ..$ values: chr [1:2] "none" "wb"
    #>   .. ..$ type  : chr "character"
    #>   ..$ welfare_type   :List of 2
    #>   .. ..$ values: chr [1:3] "all" "consumption" "income"
    #>   .. ..$ type  : chr "character"
    #>   ..$ reporting_level:List of 2
    #>   .. ..$ values: chr [1:4] "all" "national" "rural" "urban"
    #>   .. ..$ type  : chr "character"
    #>   ..$ ppp            :List of 2
    #>   .. ..$ values: Named num [1:2] 0e+00 1e+06
    #>   .. .. ..- attr(*, "names")= chr [1:2] "min" "max"
    #>   .. ..$ type  : chr "numeric"
    #>   ..$ version        : 'fs_path' Named chr [1:3] "./tests/testdata/20210401/estimations" "./tests/testdata/20210401/survey_data" "./tests/testdata/20210401/_aux"
    #>   .. ..- attr(*, "names")= chr [1:3] "./tests/testdata/20210401/estimations" "./tests/testdata/20210401/survey_data" "./tests/testdata/20210401/_aux"
    #>  $ data_root     : chr "./tests/testdata/20210401/"

### Run package functions

Pass the `lkups` list to the main `pip()` function to compute poverty
and inequality statistics in your `R` session.

``` r
library(pipapi)

pip(country = "AGO",
    year = 2000,
    povline = 1.9,
    lkup = lkups)
#>                    cache_id country_code reporting_year welfare_type
#> 1: AGO_2000_HBS_D1_CON_GPWG          AGO           2000  consumption
#>    pop_data_level   median      gini polarization       mld    decile1
#> 1:       national 2.593394 0.5195689    0.4643401 0.5125765 0.00983246
#>       decile2    decile3    decile4    decile5    decile6    decile7   decile8
#> 1: 0.02195307 0.03342455 0.04495307 0.05662774 0.07048758 0.08808485 0.1134946
#>     decile9  decile10                            survey_id wb_region_code
#> 1: 0.158687 0.4024552 AGO_2000_HBS_V01_M_V01_A_PIP_PC-GPWG            SSA
#>    pcn_region_code survey_acronym survey_coverage survey_comparability
#> 1:             SSA            HBS        national                    0
#>    surveyid_year survey_year survey_mean_lcu survey_mean_ppp reporting_pop
#> 1:          2000     2000.21        11.23264        4.100014      16395473
#>        ppp        cpi gdp_data_level pce_data_level cpi_data_level
#> 1: 80.9318 0.03385145       national       national       national
#>    ppp_data_level distribution_type gd_type is_interpolated
#> 1:       national             micro                   FALSE
#>    is_used_for_aggregation
#> 1:                   FALSE
#>                                                                  path
#> 1: ./tests/testdata/20210401/survey_data/AGO_2000_HBS_D1_CON_GPWG.fst
#>    poverty_line     mean headcount poverty_gap poverty_severity     watts
#> 1:          1.9 4.100014 0.3557108   0.1625061       0.09664022 0.2719677
```
